<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - ComptabilitÃ©</title>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --accent: #10b981; --secondary: #3b82f6; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #334155; padding-bottom: 1rem; }
        .user-badge { background: #334155; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px;}

        /* STATS GLOBALES */
        .total-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 2rem; border-radius: 16px; text-align: center; margin-bottom: 3rem;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.2);
        }
        .total-label { font-size: 1.1rem; opacity: 0.9; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .total-amount { font-size: 4rem; font-weight: 700; margin: 10px 0 0 0; }

        /* GRILLE PAR PRODUIT */
        h2 { border-left: 4px solid var(--secondary); padding-left: 15px; margin-bottom: 1.5rem; color: var(--secondary); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        
        .stat-card { background: var(--card-bg); padding: 1.5rem; border-radius: 12px; border: 1px solid #334155; display: flex; flex-direction: column; justify-content: space-between; height: 120px; }
        .prod-name { font-size: 1.1rem; color: #94a3b8; font-weight: 600; }
        .prod-amount { font-size: 2rem; font-weight: 700; color: white; text-align: right; }
        .prod-count { font-size: 0.8rem; color: #64748b; margin-top: 5px; }

        /* TABLEAU DETAIL (Optionnel pour vÃ©rification) */
        .table-container { margin-top: 3rem; background: var(--card-bg); border-radius: 12px; padding: 1rem; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 15px; color: #94a3b8; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #334155; font-size: 0.95rem; }
        .status-paid { color: var(--accent); font-weight: bold; }
        .status-pending { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’° Tableau de Bord Financier</h1>
            <div>
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">Quitter</button>
            </div>
        </header>

        <div class="total-card">
            <div class="total-label">Chiffre d'Affaires Total</div>
            <div class="total-amount" id="global-total">0.00 DT</div>
        </div>

        <h2>DÃ©tail par Produit</h2>
        <div id="stats-grid" class="stats-grid">
            </div>

        <h2>Historique Commandes</h2>
        <div class="table-container">
            <table>
                <thead><tr><th>Date</th><th>Client</th><th>Produit</th><th>Montant</th><th>Ã‰tat</th></tr></thead>
                <tbody id="orders-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // AUTHENTIFICATION
        const user = checkAuth(['admin', 'compta']); // Accessible par Admin et Compta
        if(user) document.getElementById('user-name-display').textContent = user.name;

        function loadStats() {
            const orders = getOrders(); // RÃ©cupÃ¨re les commandes depuis users.js (LocalStorage)
            
            let totalGlobal = 0;
            let breakdown = {};

            const tbody = document.getElementById('orders-table-body');
            tbody.innerHTML = '';

            // CALCULS
            orders.forEach(order => {
                const price = parseFloat(order.price);
                
                // Total Global
                totalGlobal += price;

                // Total par Produit
                if(!breakdown[order.prod]) {
                    breakdown[order.prod] = { amount: 0, count: 0 };
                }
                breakdown[order.prod].amount += price;
                breakdown[order.prod].count += 1;

                // Remplissage tableau bas
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="color:#64748b">${order.date}</td>
                    <td><strong>${order.client}</strong></td>
                    <td>${order.prod}</td>
                    <td style="font-family:monospace; font-size:1.1em;">${price.toFixed(2)} DT</td>
                    <td class="${order.statusCompta === 'PayÃ©' ? 'status-paid' : 'status-pending'}">${order.statusCompta}</td>
                `;
            });

            // AFFICHAGE TOTAL
            document.getElementById('global-total').textContent = totalGlobal.toLocaleString('fr-FR', {minimumFractionDigits: 2}) + " DT";

            // AFFICHAGE CARTES PRODUITS
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = '';
            
            // On trie pour afficher les plus gros revenus en premier
            const sortedProducts = Object.keys(breakdown).sort((a,b) => breakdown[b].amount - breakdown[a].amount);

            sortedProducts.forEach(prodName => {
                const data = breakdown[prodName];
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="prod-name">${prodName}</div>
                    <div>
                        <div class="prod-amount">${data.amount.toFixed(2)} <span style="font-size:0.5em; vertical-align:middle;">DT</span></div>
                        <div class="prod-count">${data.count} commandes</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        loadStats();
    </script>
</body>
</html>
