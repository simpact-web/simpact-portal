<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Gestion Stock Papier</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // FONCTIONS ESSENTIELLES D'AUTHENTIFICATION
        let USERS = [
            { id: 'youssef', pass: 'ni3Shaey', role: 'superadmin', name: 'Youssef (SUPER ADMIN)', redirect: 'admin.html' },
            { id: 'admin01', pass: 'simpact2026', role: 'admin', name: 'Youssef (PDG)', redirect: 'admin.html' },
            { id: 'prod01', pass: 'atelier', role: 'production', name: 'Chef Atelier', redirect: 'production.html' }
        ];

        function getAllUsers() {
            const savedUsers = localStorage.getItem('SIMPACT_USERS');
            if(savedUsers) {
                USERS = JSON.parse(savedUsers);
            }
            return USERS;
        }

        function checkAuth(allowedRoles) {
            const session = localStorage.getItem('SIMPACT_USER');
            if (!session) {
                window.location.href = 'index.html';
                return null;
            }
            
            const user = JSON.parse(session);
            
            // Le superadmin a acc√®s √† TOUT
            if(user.role === 'superadmin') return user;
            
            if (!allowedRoles) return user;

            if (Array.isArray(allowedRoles) && !allowedRoles.includes(user.role)) {
                alert("‚õî Acc√®s interdit √† cette zone !");
                window.location.href = user.redirect;
                return null;
            } else if (typeof allowedRoles === 'string' && allowedRoles !== user.role) {
                alert("‚õî Acc√®s interdit !");
                window.location.href = user.redirect;
                return null;
            }

            return user;
        }

        function logout() {
            localStorage.removeItem('SIMPACT_USER');
            window.location.href = 'index.html';
        }

        // Charger les utilisateurs au d√©marrage
        getAllUsers();
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #0f172a; 
            --card-bg: #1e293b; 
            --text: #f1f5f9; 
            --accent: #8b5cf6; 
            --success: #10b981; 
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding: 2rem; 
            margin: 0; 
        }
        
        .container { max-width: 1400px; margin: 0 auto; }

        /* HEADER */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 2rem; 
            border-bottom: 1px solid #334155; 
            padding-bottom: 1rem; 
        }
        
        .user-badge { 
            background: #334155; 
            padding: 5px 15px; 
            border-radius: 20px; 
            font-size: 0.9rem; 
        }
        
        .logout-btn { 
            background: #ef4444; 
            color: white; 
            border: none; 
            padding: 8px 15px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            margin-left: 10px;
        }

        /* STATS GLOBALES */
        .stats-bar { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }
        
        .stat-card { 
            background: var(--card-bg); 
            padding: 1.5rem; 
            border-radius: 12px; 
            border-left: 4px solid var(--accent); 
        }
        
        .stat-label { 
            font-size: 0.9rem; 
            color: #94a3b8; 
            margin-bottom: 0.5rem; 
        }
        
        .stat-value { 
            font-size: 2rem; 
            font-weight: 700; 
            color: white; 
        }
        
        .stat-value small { 
            font-size: 0.5em; 
            color: #64748b; 
            font-weight: 400; 
        }

        /* TOOLBAR */
        .toolbar { 
            display: flex; 
            gap: 1rem; 
            margin-bottom: 2rem; 
            flex-wrap: wrap; 
        }
        
        .btn { 
            padding: 12px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            font-family: inherit; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: transform 0.2s; 
        }
        
        .btn:hover { transform: translateY(-2px); }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #334155; color: white; }
        
        .search-box { 
            flex: 1; 
            min-width: 250px; 
        }
        
        .search-box input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            background: var(--card-bg); 
            color: var(--text); 
            font-family: inherit; 
        }

        /* FILTRES */
        .filters { 
            display: flex; 
            gap: 1rem; 
            margin-bottom: 2rem; 
            flex-wrap: wrap; 
        }
        
        .filter-btn { 
            padding: 8px 16px; 
            border: 2px solid #334155; 
            background: transparent; 
            color: #94a3b8; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s; 
        }
        
        .filter-btn.active { 
            border-color: var(--accent); 
            background: var(--accent); 
            color: white; 
        }
        
        .filter-btn:hover { 
            border-color: var(--accent); 
            color: var(--accent); 
        }

        /* GRILLE DE STOCK */
        .stock-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }
        
        .stock-card { 
            background: var(--card-bg); 
            border-radius: 12px; 
            padding: 1.5rem; 
            border: 2px solid #334155; 
            position: relative; 
            transition: all 0.2s; 
        }
        
        .stock-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2); 
        }
        
        .stock-card.alert-low { border-left: 5px solid var(--danger); }
        .stock-card.alert-medium { border-left: 5px solid var(--warning); }
        .stock-card.alert-ok { border-left: 5px solid var(--success); }
        
        .stock-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 1rem; 
        }
        
        .paper-type { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: white; 
            margin: 0; 
        }
        
        .paper-specs { 
            font-size: 0.85rem; 
            color: #94a3b8; 
            margin: 5px 0; 
        }
        
        .status-badge { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.75rem; 
            font-weight: 700; 
            text-transform: uppercase; 
        }
        
        .status-ok { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .status-medium { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .status-low { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        
        .stock-qty { 
            text-align: center; 
            padding: 1.5rem 0; 
            border-top: 1px solid #334155; 
            border-bottom: 1px solid #334155; 
            margin: 1rem 0; 
        }
        
        .qty-number { 
            font-size: 2.5rem; 
            font-weight: 700; 
            color: var(--accent); 
            display: block; 
        }
        
        .qty-label { 
            font-size: 0.85rem; 
            color: #64748b; 
            margin-top: 5px; 
        }
        
        .stock-info { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 0.5rem; 
            font-size: 0.85rem; 
            margin-bottom: 1rem; 
        }
        
        .info-item { 
            display: flex; 
            justify-content: space-between; 
            color: #94a3b8; 
        }
        
        .info-value { 
            color: white; 
            font-weight: 600; 
        }
        
        .stock-actions { 
            display: flex; 
            gap: 8px; 
        }
        
        .action-btn { 
            flex: 1; 
            padding: 10px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem; 
        }
        
        .btn-in { background: var(--success); color: white; }
        .btn-out { background: var(--danger); color: white; }
        .btn-edit { background: #334155; color: white; }

        /* MODAL */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 9999; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        
        .modal-content { 
            background: var(--card-bg); 
            padding: 2rem; 
            border-radius: 16px; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1.5rem; 
            padding-bottom: 1rem; 
            border-bottom: 2px solid #334155; 
        }
        
        .modal-title { 
            font-size: 1.5rem; 
            color: var(--accent); 
            margin: 0; 
        }
        
        .close-btn { 
            background: none; 
            border: none; 
            color: #94a3b8; 
            font-size: 2rem; 
            cursor: pointer; 
            line-height: 1; 
        }
        
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        
        label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 0.5rem; 
            color: #cbd5e1; 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #334155; 
            border-radius: 8px; 
            background: #0f172a; 
            color: var(--text); 
            font-family: inherit; 
            font-size: 1rem; 
        }
        
        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--accent); 
        }
        
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 1rem; 
        }

        /* HISTORIQUE */
        .history-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 1rem; 
        }
        
        .history-table th { 
            text-align: left; 
            padding: 12px; 
            color: #94a3b8; 
            border-bottom: 2px solid #334155; 
            font-size: 0.9rem; 
        }
        
        .history-table td { 
            padding: 12px; 
            border-bottom: 1px solid #334155; 
        }
        
        .move-in { color: var(--success); font-weight: 700; }
        .move-out { color: var(--danger); font-weight: 700; }

        /* PDF TEMPLATE */
        #pdf-template { 
            background: white; 
            color: black; 
            padding: 40px; 
            display: none; 
        }
        
        .pdf-header { 
            display: flex; 
            justify-content: space-between; 
            border-bottom: 3px solid #8b5cf6; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
        }
        
        .pdf-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        }
        
        .pdf-table th { 
            background: #f1f5f9; 
            padding: 12px; 
            text-align: left; 
            border: 1px solid #cbd5e1; 
        }
        
        .pdf-table td { 
            padding: 10px; 
            border: 1px solid #cbd5e1; 
        }
        
        .pdf-total { 
            background: #8b5cf6; 
            color: white; 
            font-weight: bold; 
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .stats-bar { grid-template-columns: 1fr; }
            .stock-grid { grid-template-columns: 1fr; }
            .toolbar { flex-direction: column; }
            .filters { flex-direction: column; }
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì¶ Gestion Stock Papier</h1>
            <div>
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">Quitter</button>
            </div>
        </header>

        <!-- STATISTIQUES GLOBALES -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Types de Papier</div>
                <div class="stat-value" id="stat-types">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Stock Total</div>
                <div class="stat-value" id="stat-total">0 <small>feuilles</small></div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Valeur Stock</div>
                <div class="stat-value" id="stat-value">0 <small>DT</small></div>
            </div>
            <div class="stat-card" style="border-left-color: var(--danger);">
                <div class="stat-label">Alertes Stock Bas</div>
                <div class="stat-value" id="stat-alerts">0</div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar">
            <button class="btn btn-primary" onclick="openAddModal()">
                ‚ûï Ajouter Type de Papier
            </button>
            <button class="btn btn-success" onclick="exportPDF()">
                üìä Rapport PDF Inventaire
            </button>
            <button class="btn btn-secondary" onclick="openHistoryModal()">
                üìú Historique Complet
            </button>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="üîç Rechercher un papier..." onkeyup="filterStock()">
            </div>
        </div>

        <!-- FILTRES -->
        <div class="filters">
            <button class="filter-btn active" onclick="filterByStatus('all')">Tous</button>
            <button class="filter-btn" onclick="filterByStatus('ok')">üü¢ Stock OK</button>
            <button class="filter-btn" onclick="filterByStatus('medium')">üü† Stock Moyen</button>
            <button class="filter-btn" onclick="filterByStatus('low')">üî¥ R√©appro Urgent</button>
        </div>

        <!-- GRILLE DE STOCK -->
        <div id="stock-grid" class="stock-grid"></div>
    </div>

    <!-- MODAL AJOUT/MODIFICATION -->
    <div id="modal-form" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Ajouter un Papier</h2>
                <button class="close-btn" onclick="closeModal('modal-form')">&times;</button>
            </div>
            
            <form id="paper-form" onsubmit="savePaper(event)">
                <input type="hidden" id="paper-id">
                
                <div class="form-group">
                    <label>Type de Papier *</label>
                    <select id="paper-category" required>
                        <option value="">-- S√©lectionner --</option>
                        <optgroup label="Papiers Couch√©s">
                            <option value="Couch√© Brillant">Couch√© Brillant</option>
                            <option value="Couch√© Mat">Couch√© Mat</option>
                            <option value="Couch√© Satin√©">Couch√© Satin√©</option>
                        </optgroup>
                        <optgroup label="Papiers Offset">
                            <option value="Offset Blanc">Offset Blanc</option>
                            <option value="Offset Ivoire">Offset Ivoire</option>
                        </optgroup>
                        <optgroup label="Papiers Cr√©ation">
                            <option value="Bristol">Bristol</option>
                            <option value="Verg√©">Verg√©</option>
                            <option value="Textur√©">Textur√©</option>
                            <option value="Kraft">Kraft</option>
                            <option value="Calque">Calque</option>
                        </optgroup>
                        <optgroup label="Papiers Techniques">
                            <option value="Autocopiant">Autocopiant</option>
                            <option value="Adh√©sif">Adh√©sif (Stickers)</option>
                            <option value="Synth√©tique">Synth√©tique</option>
                        </optgroup>
                        <optgroup label="Cartons">
                            <option value="Carton Plat">Carton Plat</option>
                            <option value="Carton Ondul√©">Carton Ondul√©</option>
                            <option value="Carton Contrecoll√©">Carton Contrecoll√©</option>
                        </optgroup>
                        <optgroup label="Papiers Sp√©ciaux">
                            <option value="M√©tallis√©">M√©tallis√©</option>
                            <option value="Translucide">Translucide</option>
                            <option value="Recycl√©">Recycl√©</option>
                            <option value="S√©curis√©">S√©curis√© (Filigrane)</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Grammage (g/m¬≤) *</label>
                        <select id="paper-weight" required>
                            <option value="">-- S√©lectionner --</option>
                            <option value="60">60 g/m¬≤</option>
                            <option value="70">70 g/m¬≤</option>
                            <option value="80">80 g/m¬≤</option>
                            <option value="90">90 g/m¬≤</option>
                            <option value="100">100 g/m¬≤</option>
                            <option value="115">115 g/m¬≤</option>
                            <option value="120">120 g/m¬≤</option>
                            <option value="130">130 g/m¬≤</option>
                            <option value="135">135 g/m¬≤</option>
                            <option value="150">150 g/m¬≤</option>
                            <option value="170">170 g/m¬≤</option>
                            <option value="200">200 g/m¬≤</option>
                            <option value="250">250 g/m¬≤</option>
                            <option value="300">300 g/m¬≤</option>
                            <option value="350">350 g/m¬≤</option>
                            <option value="400">400 g/m¬≤</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Format *</label>
                        <select id="paper-format" required>
                            <option value="">-- S√©lectionner --</option>
                            <optgroup label="Formats Standard">
                                <option value="A4">A4 (21x29.7 cm)</option>
                                <option value="A3">A3 (29.7x42 cm)</option>
                                <option value="A5">A5 (14.8x21 cm)</option>
                                <option value="A6">A6 (10.5x14.8 cm)</option>
                            </optgroup>
                            <optgroup label="Formats SRA (avec fonds perdus)">
                                <option value="SRA3">SRA3 (32x45 cm)</option>
                                <option value="SRA4">SRA4 (22.5x32 cm)</option>
                            </optgroup>
                            <optgroup label="Formats Machine">
                                <option value="50x70">50x70 cm</option>
                                <option value="70x100">70x100 cm</option>
                                <option value="72x102">72x102 cm</option>
                            </optgroup>
                            <optgroup label="Formats US">
                                <option value="Letter">Letter (21.6x27.9 cm)</option>
                                <option value="Legal">Legal (21.6x35.6 cm)</option>
                                <option value="Tabloid">Tabloid (27.9x43.2 cm)</option>
                            </optgroup>
                            <optgroup label="Formats Personnalis√©s">
                                <option value="custom">Autre (pr√©ciser)</option>
                            </optgroup>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Quantit√© Actuelle *</label>
                        <input type="number" id="paper-qty" placeholder="Ex: 5000" required min="0">
                    </div>

                    <div class="form-group">
                        <label>Unit√© *</label>
                        <select id="paper-unit" required>
                            <option value="feuilles">Feuilles</option>
                            <option value="ramettes">Ramettes (500 feuilles)</option>
                            <option value="palettes">Palettes</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Seuil d'Alerte *</label>
                        <input type="number" id="paper-threshold" placeholder="Ex: 1000" required min="0">
                    </div>

                    <div class="form-group">
                        <label>Prix Unitaire (DT)</label>
                        <input type="number" id="paper-price" placeholder="Ex: 0.025" step="0.001" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label>Fournisseur</label>
                    <input type="text" id="paper-supplier" placeholder="Ex: Papeterie du Nord">
                </div>

                <div class="form-group">
                    <label>Notes / Sp√©cifications</label>
                    <textarea id="paper-notes" rows="3" placeholder="Ex: Pour impressions photo uniquement"></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">üíæ Enregistrer</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-form')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL MOUVEMENT -->
    <div id="modal-movement" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="movement-title">Mouvement de Stock</h2>
                <button class="close-btn" onclick="closeModal('modal-movement')">&times;</button>
            </div>
            
            <form id="movement-form" onsubmit="saveMovement(event)">
                <input type="hidden" id="movement-paper-id">
                <input type="hidden" id="movement-type">
                
                <div class="form-group">
                    <label>Quantit√© *</label>
                    <input type="number" id="movement-qty" placeholder="Ex: 1000" required min="1">
                </div>

                <div class="form-group">
                    <label>Motif *</label>
                    <select id="movement-reason" required>
                        <option value="">-- S√©lectionner --</option>
                        <optgroup label="Entr√©es">
                            <option value="Achat fournisseur">Achat fournisseur</option>
                            <option value="Retour client">Retour client</option>
                            <option value="Correction inventaire">Correction inventaire</option>
                        </optgroup>
                        <optgroup label="Sorties">
                            <option value="Production commande">Production commande</option>
                            <option value="Perte/Casse">Perte/Casse</option>
                            <option value="√âchantillon client">√âchantillon client</option>
                            <option value="Test qualit√©">Test qualit√©</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label>R√©f√©rence (optionnel)</label>
                    <input type="text" id="movement-ref" placeholder="Ex: Commande #12345 ou Bon de livraison BL-456">
                </div>

                <div class="form-group">
                    <label>Commentaire</label>
                    <textarea id="movement-comment" rows="2" placeholder="D√©tails suppl√©mentaires..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úÖ Valider Mouvement</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-movement')">Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL HISTORIQUE -->
    <div id="modal-history" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 class="modal-title">üìú Historique des Mouvements</h2>
                <button class="close-btn" onclick="closeModal('modal-history')">&times;</button>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <input type="text" id="history-search" placeholder="üîç Rechercher dans l'historique..." 
                       onkeyup="filterHistory()" style="width: 100%;">
            </div>

            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type Papier</th>
                            <th>Mouvement</th>
                            <th>Quantit√©</th>
                            <th>Motif</th>
                            <th>R√©f√©rence</th>
                            <th>Op√©rateur</th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PDF TEMPLATE (Cach√©) -->
    <div id="pdf-template">
        <div class="pdf-header">
            <div>
                <h1 style="color: #8b5cf6; margin: 0;">RAPPORT D'INVENTAIRE</h1>
                <p style="margin: 5px 0;">Stock Papier Simpact</p>
                <p style="margin: 5px 0; font-size: 0.9rem;" id="pdf-date"></p>
            </div>
            <div style="text-align: right;">
                <h2 style="margin: 0;">SIMPACT</h2>
                <p style="margin: 5px 0;">Gestion Stock</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9rem; color: #64748b;">Types de Papier</div>
                <div style="font-size: 2rem; font-weight: bold;" id="pdf-stat-types">0</div>
            </div>
            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9rem; color: #64748b;">Stock Total</div>
                <div style="font-size: 2rem; font-weight: bold;" id="pdf-stat-total">0</div>
            </div>
            <div style="background: #f1f5f9; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 0.9rem; color: #64748b;">Valeur Stock</div>
                <div style="font-size: 2rem; font-weight: bold;" id="pdf-stat-value">0 DT</div>
            </div>
        </div>

        <h3 style="color: #8b5cf6; border-bottom: 2px solid #8b5cf6; padding-bottom: 10px;">D√©tail par Type de Papier</h3>
        <table class="pdf-table" id="pdf-stock-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Grammage</th>
                    <th>Format</th>
                    <th>Quantit√©</th>
                    <th>Unit√©</th>
                    <th>Prix Unit.</th>
                    <th>Valeur</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body"></tbody>
        </table>
    </div>

    <script>
        // AUTHENTIFICATION
        const user = checkAuth(['admin', 'production']); // Admin et Production peuvent g√©rer le stock
        if(user) document.getElementById('user-name-display').textContent = user.name;

        // ============ GESTION DES DONN√âES ============
        
        function getStock() {
            const stock = localStorage.getItem('SIMPACT_STOCK');
            return stock ? JSON.parse(stock) : [];
        }

        function saveStock(stockData) {
            localStorage.setItem('SIMPACT_STOCK', JSON.stringify(stockData));
        }

        function getMovements() {
            const movements = localStorage.getItem('SIMPACT_STOCK_MOVEMENTS');
            return movements ? JSON.parse(movements) : [];
        }

        function saveMovement(movementData) {
            const movements = getMovements();
            movements.unshift(movementData); // Ajoute en d√©but de liste
            if(movements.length > 200) movements.pop(); // Limite √† 200 mouvements
            localStorage.setItem('SIMPACT_STOCK_MOVEMENTS', JSON.stringify(movements));
        }

        // ============ AFFICHAGE ============
        
        let currentFilter = 'all';

        function renderStock() {
            const stock = getStock();
            const grid = document.getElementById('stock-grid');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            // Filtrage
            let filteredStock = stock.filter(paper => {
                // Filtre recherche
                const matchSearch = !searchTerm || 
                    paper.category.toLowerCase().includes(searchTerm) ||
                    paper.weight.toString().includes(searchTerm) ||
                    paper.format.toLowerCase().includes(searchTerm) ||
                    (paper.supplier && paper.supplier.toLowerCase().includes(searchTerm));
                
                // Filtre statut
                const status = getStockStatus(paper);
                const matchStatus = currentFilter === 'all' || status === currentFilter;
                
                return matchSearch && matchStatus;
            });

            grid.innerHTML = '';

            if(filteredStock.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #64748b; padding: 3rem;">Aucun papier trouv√©</p>';
                return;
            }

            filteredStock.forEach(paper => {
                const status = getStockStatus(paper);
                const statusClass = status === 'ok' ? 'alert-ok' : status === 'medium' ? 'alert-medium' : 'alert-low';
                const statusBadge = status === 'ok' ? 'status-ok' : status === 'medium' ? 'status-medium' : 'status-low';
                const statusText = status === 'ok' ? 'üü¢ Stock OK' : status === 'medium' ? 'üü† Stock Moyen' : 'üî¥ R√©appro Urgent';
                
                const totalValue = paper.qty * (paper.price || 0);
                
                const card = document.createElement('div');
                card.className = `stock-card ${statusClass}`;
                card.innerHTML = `
                    <div class="stock-header">
                        <div>
                            <h3 class="paper-type">${paper.category}</h3>
                            <div class="paper-specs">${paper.weight} g/m¬≤ ‚Ä¢ ${paper.format}</div>
                        </div>
                        <span class="status-badge ${statusBadge}">${statusText}</span>
                    </div>
                    
                    <div class="stock-qty">
                        <span class="qty-number">${paper.qty.toLocaleString()}</span>
                        <div class="qty-label">${paper.unit}</div>
                    </div>
                    
                    <div class="stock-info">
                        <div class="info-item">
                            <span>Seuil:</span>
                            <span class="info-value">${paper.threshold.toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Prix/u:</span>
                            <span class="info-value">${paper.price ? paper.price.toFixed(3) + ' DT' : 'N/A'}</span>
                        </div>
                        <div class="info-item" style="grid-column: 1/-1;">
                            <span>Valeur:</span>
                            <span class="info-value">${totalValue.toFixed(2)} DT</span>
                        </div>
                        ${paper.supplier ? `
                        <div class="info-item" style="grid-column: 1/-1; font-size: 0.8rem; color: #64748b;">
                            <span>üì¶ ${paper.supplier}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="stock-actions">
                        <button class="action-btn btn-in" onclick="openMovement('${paper.id}', 'in')">‚ûï Entr√©e</button>
                        <button class="action-btn btn-out" onclick="openMovement('${paper.id}', 'out')">‚ûñ Sortie</button>
                        <button class="action-btn btn-edit" onclick="editPaper('${paper.id}')">‚úèÔ∏è</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });

            updateStats();
        }

        function getStockStatus(paper) {
            const percentage = (paper.qty / paper.threshold) * 100;
            if(percentage > 150) return 'ok';
            if(percentage > 100) return 'medium';
            return 'low';
        }

        function updateStats() {
            const stock = getStock();
            
            const totalTypes = stock.length;
            const totalQty = stock.reduce((sum, p) => sum + p.qty, 0);
            const totalValue = stock.reduce((sum, p) => sum + (p.qty * (p.price || 0)), 0);
            const alerts = stock.filter(p => getStockStatus(p) === 'low').length;
            
            document.getElementById('stat-types').textContent = totalTypes;
            document.getElementById('stat-total').innerHTML = totalQty.toLocaleString() + ' <small>feuilles</small>';
            document.getElementById('stat-value').innerHTML = totalValue.toFixed(2) + ' <small>DT</small>';
            document.getElementById('stat-alerts').textContent = alerts;
        }

        // ============ FILTRES ============
        
        function filterStock() {
            renderStock();
        }

        function filterByStatus(status) {
            currentFilter = status;
            
            // Mise √† jour boutons
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderStock();
        }

        // ============ MODAL GESTION ============
        
        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Ajouter un Type de Papier';
            document.getElementById('paper-form').reset();
            document.getElementById('paper-id').value = '';
            openModal('modal-form');
        }

        function editPaper(id) {
            const stock = getStock();
            const paper = stock.find(p => p.id === id);
            if(!paper) return;
            
            document.getElementById('modal-title').textContent = 'Modifier le Papier';
            document.getElementById('paper-id').value = paper.id;
            document.getElementById('paper-category').value = paper.category;
            document.getElementById('paper-weight').value = paper.weight;
            document.getElementById('paper-format').value = paper.format;
            document.getElementById('paper-qty').value = paper.qty;
            document.getElementById('paper-unit').value = paper.unit;
            document.getElementById('paper-threshold').value = paper.threshold;
            document.getElementById('paper-price').value = paper.price || '';
            document.getElementById('paper-supplier').value = paper.supplier || '';
            document.getElementById('paper-notes').value = paper.notes || '';
            
            openModal('modal-form');
        }

        function savePaper(event) {
            event.preventDefault();
            
            const id = document.getElementById('paper-id').value || 'PAPER-' + Date.now();
            const data = {
                id: id,
                category: document.getElementById('paper-category').value,
                weight: parseInt(document.getElementById('paper-weight').value),
                format: document.getElementById('paper-format').value,
                qty: parseFloat(document.getElementById('paper-qty').value),
                unit: document.getElementById('paper-unit').value,
                threshold: parseFloat(document.getElementById('paper-threshold').value),
                price: parseFloat(document.getElementById('paper-price').value) || 0,
                supplier: document.getElementById('paper-supplier').value,
                notes: document.getElementById('paper-notes').value,
                createdAt: new Date().toISOString()
            };
            
            let stock = getStock();
            const existingIndex = stock.findIndex(p => p.id === id);
            
            if(existingIndex >= 0) {
                stock[existingIndex] = data;
            } else {
                stock.push(data);
            }
            
            saveStock(stock);
            closeModal('modal-form');
            renderStock();
            
            alert('‚úÖ Papier enregistr√© avec succ√®s !');
        }

        // ============ MOUVEMENTS ============
        
        function openMovement(paperId, type) {
            document.getElementById('movement-paper-id').value = paperId;
            document.getElementById('movement-type').value = type;
            document.getElementById('movement-title').textContent = type === 'in' ? '‚ûï Entr√©e de Stock' : '‚ûñ Sortie de Stock';
            document.getElementById('movement-form').reset();
            openModal('modal-movement');
        }

        function saveMovement(event) {
            event.preventDefault();
            
            const paperId = document.getElementById('movement-paper-id').value;
            const type = document.getElementById('movement-type').value;
            const qty = parseFloat(document.getElementById('movement-qty').value);
            const reason = document.getElementById('movement-reason').value;
            const ref = document.getElementById('movement-ref').value;
            const comment = document.getElementById('movement-comment').value;
            
            let stock = getStock();
            const paper = stock.find(p => p.id === paperId);
            
            if(!paper) {
                alert('‚ùå Erreur: Papier introuvable');
                return;
            }
            
            // Mise √† jour quantit√©
            if(type === 'in') {
                paper.qty += qty;
            } else {
                if(paper.qty < qty) {
                    if(!confirm('‚ö†Ô∏è Stock insuffisant ! Continuer quand m√™me ?')) {
                        return;
                    }
                }
                paper.qty -= qty;
                if(paper.qty < 0) paper.qty = 0;
            }
            
            saveStock(stock);
            
            // Enregistrement mouvement
            const movement = {
                id: 'MOV-' + Date.now(),
                paperId: paperId,
                paperName: `${paper.category} ${paper.weight}g ${paper.format}`,
                type: type,
                qty: qty,
                reason: reason,
                ref: ref,
                comment: comment,
                date: new Date().toLocaleString('fr-FR'),
                user: user.name
            };
            
            saveMovement(movement);
            
            closeModal('modal-movement');
            renderStock();
            
            alert('‚úÖ Mouvement enregistr√© !');
        }

        // ============ HISTORIQUE ============
        
        function openHistoryModal() {
            renderHistory();
            openModal('modal-history');
        }

        function renderHistory() {
            const movements = getMovements();
            const tbody = document.getElementById('history-table-body');
            const searchTerm = document.getElementById('history-search')?.value.toLowerCase() || '';
            
            tbody.innerHTML = '';
            
            const filtered = movements.filter(m => {
                return !searchTerm || 
                    m.paperName.toLowerCase().includes(searchTerm) ||
                    m.reason.toLowerCase().includes(searchTerm) ||
                    m.ref.toLowerCase().includes(searchTerm) ||
                    m.user.toLowerCase().includes(searchTerm);
            });
            
            if(filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">Aucun mouvement trouv√©</td></tr>';
                return;
            }
            
            filtered.forEach(m => {
                const row = tbody.insertRow();
                const sign = m.type === 'in' ? '+' : '-';
                const className = m.type === 'in' ? 'move-in' : 'move-out';
                
                row.innerHTML = `
                    <td style="color: #94a3b8;">${m.date}</td>
                    <td><strong>${m.paperName}</strong></td>
                    <td class="${className}">${m.type === 'in' ? '‚ûï Entr√©e' : '‚ûñ Sortie'}</td>
                    <td class="${className}">${sign}${m.qty.toLocaleString()}</td>
                    <td>${m.reason}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">${m.ref || '-'}</td>
                    <td>${m.user}</td>
                `;
            });
        }

        function filterHistory() {
            renderHistory();
        }

        // ============ EXPORT PDF ============
        
        function exportPDF() {
            const stock = getStock();
            
            // Mise √† jour du template
            document.getElementById('pdf-date').textContent = new Date().toLocaleString('fr-FR');
            document.getElementById('pdf-stat-types').textContent = stock.length;
            document.getElementById('pdf-stat-total').textContent = stock.reduce((s, p) => s + p.qty, 0).toLocaleString();
            document.getElementById('pdf-stat-value').textContent = stock.reduce((s, p) => s + (p.qty * (p.price || 0)), 0).toFixed(2) + ' DT';
            
            const tbody = document.getElementById('pdf-table-body');
            tbody.innerHTML = '';
            
            let totalValue = 0;
            
            stock.forEach(paper => {
                const value = paper.qty * (paper.price || 0);
                totalValue += value;
                
                const status = getStockStatus(paper);
                const statusText = status === 'ok' ? '‚úÖ OK' : status === 'medium' ? '‚ö†Ô∏è Moyen' : 'üî¥ Bas';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${paper.category}</td>
                    <td>${paper.weight} g/m¬≤</td>
                    <td>${paper.format}</td>
                    <td style="text-align: right; font-weight: bold;">${paper.qty.toLocaleString()}</td>
                    <td>${paper.unit}</td>
                    <td style="text-align: right;">${paper.price ? paper.price.toFixed(3) : '-'}</td>
                    <td style="text-align: right; font-weight: bold;">${value.toFixed(2)} DT</td>
                    <td>${statusText}</td>
                `;
            });
            
            // Ligne total
            const totalRow = tbody.insertRow();
            totalRow.className = 'pdf-total';
            totalRow.innerHTML = `
                <td colspan="6" style="text-align: right;">VALEUR TOTALE DU STOCK</td>
                <td style="text-align: right; font-size: 1.2em;">${totalValue.toFixed(2)} DT</td>
                <td></td>
            `;
            
            // G√©n√©ration PDF
            const element = document.getElementById('pdf-template');
            const opt = {
                margin: 10,
                filename: `Stock_Papier_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            
            html2pdf().from(element).set(opt).save();
        }

        // ============ HELPERS ============
        
        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Fermeture modal par clic ext√©rieur
        window.onclick = function(event) {
            if(event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ============ INITIALISATION ============
        
        // Chargement initial
        renderStock();
        
        // Auto-refresh toutes les 30 secondes
        setInterval(renderStock, 30000);
    </script>
</body>
</html>
