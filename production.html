<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Atelier Production</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --card-bg: #1e293b; --text: #f1f5f9; --accent: #f59e0b; --success: #10b981; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid #334155; padding-bottom: 1rem; }
        .user-badge { background: #334155; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; }
        .logout-btn { background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px;}

        /* LISTE DES COMMANDES */
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        
        .order-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; border-left: 5px solid var(--accent); position: relative; transition: transform 0.2s; }
        .order-card:hover { transform: translateY(-3px); }
        .order-card.done { border-left-color: var(--success); opacity: 0.7; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .ref { font-family: monospace; color: #94a3b8; font-size: 0.9rem; }
        .date { font-size: 0.8rem; color: #64748b; }
        
        .product-title { font-size: 1.4rem; font-weight: 700; color: white; margin: 0 0 5px 0; }
        .client-name { color: var(--accent); font-weight: 600; margin-bottom: 1rem; display: block; }
        
        .specs-box { background: #0f172a; padding: 1rem; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; color: #cbd5e1; margin-bottom: 1.5rem; white-space: pre-line; border: 1px dashed #475569; }

        .actions { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-pdf { background: #334155; color: white; }
        .btn-status { background: var(--accent); color: #fff; }
        .btn-status.done { background: var(--success); }

        /* OVERLAY PDF (Cach√© par d√©faut) */
        #pdf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px; color: black; }
        #pdf-template { background: white; width: 210mm; min-height: 297mm; padding: 20mm; box-sizing: border-box; }
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
        #pdf-atelier-content { font-size: 16px; line-height: 1.8; border: 2px dashed #ea580c; padding: 20px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè≠ File de Production</h1>
            <div>
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">Quitter</button>
            </div>
        </header>

        <div id="orders-list" class="orders-grid">
            </div>
    </div>

    <div id="pdf-overlay">
        <div id="pdf-template">
            <div class="pdf-header">
                <div><h1 style="color:#ea580c; margin:0;">ORDRE DE FABRICATION</h1><p>R√©f: <span id="pdf-ref"></span></p></div>
                <div style="text-align:right;"><h2>SIMPACT</h2><p>Atelier</p></div>
            </div>
            <div style="margin-bottom:30px; font-size: 1.2rem;">
                <strong>Client :</strong> <span id="pdf-client"></span><br>
                <strong>Produit :</strong> <span id="pdf-prod"></span><br>
                <strong>Quantit√© :</strong> <span id="pdf-qty" style="font-size:1.5em; font-weight:bold;"></span>
            </div>
            <h3>üìã INSTRUCTIONS TECHNIQUES</h3>
            <div id="pdf-atelier-content"></div>
        </div>
        <div style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:10px;">
            <button onclick="downloadPdf()" style="padding:15px 30px; border-radius:30px; border:none; background:#2563eb; color:white; font-weight:bold; cursor:pointer;">üíæ T√âL√âCHARGER</button>
            <button onclick="document.getElementById('pdf-overlay').style.display='none'" style="padding:15px 30px; border-radius:30px; border:none; background:white; color:black; font-weight:bold; cursor:pointer;">FERMER</button>
        </div>
    </div>

    <script>
        // 1. SECURIT√â
        const user = checkAuth(['production', 'admin']); // Seul la Prod ou l'Admin entre
        if(user) document.getElementById('user-name-display').textContent = user.name;

        // 2. CHARGEMENT DES COMMANDES
        function renderOrders() {
            const list = document.getElementById('orders-list');
            const orders = getOrders(); // Vient de users.js (LocalStorage)
            list.innerHTML = '';

            if(orders.length === 0) {
                list.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#64748b; font-size:1.2rem;">Aucune commande en attente üò¥</p>';
                return;
            }

            orders.forEach(order => {
                const isDone = order.statusProd === 'Termin√©';
                const btnText = isDone ? '‚úÖ Termin√©' : '‚è≥ En cours';
                const btnClass = isDone ? 'done' : '';
                
                // Cr√©ation de la carte HTML
                const card = document.createElement('div');
                card.className = `order-card ${isDone ? 'done' : ''}`;
                card.innerHTML = `
                    <div class="card-header">
                        <span class="ref">#${order.ref}</span>
                        <span class="date">${order.date}</span>
                    </div>
                    <h3 class="product-title">${order.prod}</h3>
                    <span class="client-name">${order.client}</span>
                    <div class="specs-box"><strong>Qt√©: ${order.qty}</strong>\n\n${order.desc}</div>
                    <div class="actions">
                        <button class="btn btn-pdf" onclick="openPdf('${order.ref}')">üìÑ Fiche</button>
                        <button class="btn btn-status ${btnClass}" onclick="toggleStatus('${order.ref}')">${btnText}</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        // 3. ACTIONS
        function toggleStatus(ref) {
            const orders = getOrders();
            const order = orders.find(o => o.ref === ref);
            if(order) {
                const newStatus = order.statusProd === 'Termin√©' ? 'En attente' : 'Termin√©';
                updateOrderStatus(ref, newStatus, 'prod'); // Sauvegarde dans users.js
                renderOrders(); // Rafraichit l'√©cran
            }
        }

        // 4. PDF
        let currentPdfOrder = null;
        function openPdf(ref) {
            const orders = getOrders();
            currentPdfOrder = orders.find(o => o.ref === ref);
            if(!currentPdfOrder) return;

            document.getElementById('pdf-ref').textContent = currentPdfOrder.ref;
            document.getElementById('pdf-client').textContent = currentPdfOrder.client;
            document.getElementById('pdf-prod').textContent = currentPdfOrder.prod;
            document.getElementById('pdf-qty').textContent = currentPdfOrder.qty;
            document.getElementById('pdf-atelier-content').innerHTML = currentPdfOrder.desc.replace(/\n/g, '<br>'); // Respecte les sauts de ligne
            
            document.getElementById('pdf-overlay').style.display = 'flex';
        }

        function downloadPdf() {
            const element = document.getElementById('pdf-template');
            const opt = { margin: 10, filename: `OF_${currentPdfOrder.ref}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save();
        }

        // Auto-refresh toutes les 5 secondes (pour voir les nouvelles commandes sans recharger)
        setInterval(renderOrders, 5000);
        
        // Premier affichage
        renderOrders();
    </script>
</body>
</html>
