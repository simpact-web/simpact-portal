<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Espace Commercial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --text: #1e293b; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
        
        /* HEADER */
        header { grid-column: 1 / -1; background: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
        .logout-btn { background: #fee2e2; color: #991b1b; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* CARDS */
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; color: #475569; }
        select, input { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        
        /* OPTIONS */
        .option-group { display: none; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .option-group.active { display: block; }
        
        /* RADIOS */
        .radio-group { display: flex; gap: 10px; }
        .radio-option { flex: 1; }
        .radio-option input { display: none; }
        .radio-option label { display: block; padding: 10px; border: 1px solid var(--border); text-align: center; border-radius: 6px; cursor: pointer; background: white; font-size: 0.9rem; transition: 0.2s; }
        .radio-option input:checked + label { background: var(--primary); color: white; border-color: var(--primary); }

        /* RESULTATS */
        .price-display { font-size: 3rem; font-weight: 700; color: var(--primary); font-family: 'Space Mono', monospace; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; background: #0f172a; color: white; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* WORKFLOW */
        .workflow-actions { margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px; transition: opacity 0.3s; }
        .workflow-step { margin-bottom: 15px; }
        .step-title { font-size: 0.85rem; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; }
        .btn-action { width: 100%; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; font-size: 0.9rem; }
        .btn-compta { background: #dcfce7; color: #166534; } 
        .btn-atelier { background: #ffedd5; color: #9a3412; }
        .btn-email { background: #2563eb; color: white; }

        /* --- ZONE DE GENERATION PDF (OVERLAY) --- */
        #pdf-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: none; /* Cach√© par d√©faut */
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 20px;
        }

        #pdf-template { 
            background: white; 
            width: 210mm; /* Largeur A4 */
            min-height: 297mm; /* Hauteur A4 */
            padding: 20mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            font-family: Arial, sans-serif; 
            color: #000;
            box-sizing: border-box;
        }

        /* Styles internes du PDF pour impression parfaite */
        .pdf-header { display: flex; justify-content: space-between; border-bottom: 3px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
        .pdf-title { font-size: 24px; text-transform: uppercase; margin: 0; font-weight: 800; }
        .pdf-info-box { border: 1px solid #000; padding: 15px; margin-bottom: 20px; background: #f8f8f8; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 2px solid #000; }
        .pdf-table th { background: #eee; border: 1px solid #000; padding: 10px; text-align: left; font-weight: bold; }
        .pdf-table td { border: 1px solid #000; padding: 12px; vertical-align: top; }
        .pdf-price-col { width: 20%; text-align: right; font-weight: bold; }
        
        /* Classes utilitaires pour masquer/afficher selon le mode */
        .mode-prod .pdf-price-col { display: none; }
        .mode-prod .pdf-price-header { display: none; }
        .mode-compta #atelier-notes { display: none; }
        .mode-prod #atelier-notes { display: block; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="margin:0;">üí† Simpact Commercial</h2>
            </div>
            <div class="user-info">
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </header>

        <div class="card">
            <h3>üõ†Ô∏è Configuration du Devis</h3>
            <div class="form-group"><label>Client</label><input type="text" id="client-name" placeholder="Nom du client..."></div>
            <div class="form-group">
                <label>Produit</label>
                <select id="product-type">
                    <option value="">-- S√©lectionner --</option>
                    <option value="flyer">Flyers</option>
                    <option value="carte">Cartes de visite</option>
                    <option value="depliant">D√©pliants 3 volets</option>
                    <option value="entete">Papier √† en-t√™te</option>
                    <option value="brochure">Brochure couleur</option>
                    <option value="livre">Livre N&B</option>
                    <option value="affiches">Affiches Grand Format</option>
                </select>
            </div>
            <div class="form-group"><label>Quantit√©</label><input type="number" id="quantity" placeholder="Ex: 500"></div>

            <div id="flyer-options" class="option-group">
                <div class="form-group"><label>Impression</label><div class="radio-group"><div class="radio-option"><input type="radio" name="flyer-type" value="recto" id="fr" checked><label for="fr">Recto</label></div><div class="radio-option"><input type="radio" name="flyer-type" value="rectoVerso" id="frv"><label for="frv">R/V</label></div></div></div>
                <div class="form-group"><label>Papier</label><select id="flyer-paper"><option value="couche-135-brillant">135g Brillant</option><option value="couche-170-brillant">170g Brillant</option></select></div>
            </div>

            <div id="carte-options" class="option-group">
                <div class="form-group"><label>Finition</label><div class="radio-group"><div class="radio-option"><input type="radio" name="carte-finish" value="recto" id="cr" checked><label for="cr">Standard</label></div><div class="radio-option"><input type="radio" name="carte-finish" value="pellicule" id="cp"><label for="cp">Pellicul√©</label></div></div></div>
                <div class="form-group"><label>Papier</label><select id="carte-paper"><option value="couche-350-mat">350g Mat</option><option value="couche-350-brillant">350g Brillant</option></select></div>
            </div>

            <div id="depliant-options" class="option-group"><div class="form-group"><label>Papier</label><select id="depliant-paper"><option value="couche-135-brillant">135g Brillant</option><option value="couche-170-brillant">170g Brillant</option></select></div></div>
            <div id="entete-options" class="option-group"><div class="form-group"><label>Papier</label><select id="entete-paper"><option value="offset-80">Offset 80g</option><option value="offset-100">Offset 100g</option></select></div></div>
            <div id="affiches-options" class="option-group"><div class="form-group"><label>Format</label><select id="affiche-format"><option value="a3">A3</option><option value="a3plus">A3+</option></select></div><div class="form-group"><label>Papier</label><select id="affiche-paper"><option value="couche-200-brillant">200g Brillant</option></select></div></div>

            <div id="brochure-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="brochure-format"><option value="a4">A4 (21x29.7 cm)</option><option value="a5">A5 (14.8x21 cm)</option></select></div>
                <div class="form-group"><label>Pages (Multiple de 4)</label><input type="number" id="brochure-pages" placeholder="Ex: 8, 12, 16..."></div>
                <div class="form-group"><label>Papier Int√©rieur</label><select id="brochure-interior-paper"><option value="couche-135-brillant">135g Brillant</option><option value="couche-115-brillant">115g Brillant</option><option value="offset-80">Offset 80g</option></select></div>
                <div class="form-group"><label>Papier Couverture</label><select id="brochure-cover-paper"><option value="couche-250-brillant">250g Brillant</option><option value="couche-300-mat">300g Mat</option></select></div>
                <div class="form-group"><label>Type Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-cover-type" value="recto" id="bcr" checked><label for="bcr">Recto</label></div><div class="radio-option"><input type="radio" name="brochure-cover-type" value="rectoVerso" id="bcrv"><label for="bcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Finition</label><select id="brochure-finition"><option value="Piqu√©e √† cheval">Piqu√©e √† cheval (Agraf√©)</option><option value="Dos carr√© coll√©">Dos carr√© coll√©</option><option value="Spirale">Spirale</option></select></div>
                <div class="form-group"><label>Pelliculage Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="sans" id="bps" checked><label for="bps">Non</label></div><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="avec" id="bpa"><label for="bpa">Oui</label></div></div></div>
            </div>

            <div id="livre-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="livre-format"><option value="a4">A4</option><option value="a5">A5</option></select></div>
                <div class="form-group"><label>Pages</label><input type="number" id="livre-pages"></div>
                <div class="form-group"><label>Int√©rieur</label><select id="livre-interior-paper"><option value="offset-80">Offset 80g</option></select></div>
                <div class="form-group"><label>Couverture</label><select id="livre-cover-paper"><option value="couche-250-brillant">250g Brillant</option></select></div>
                <div class="form-group"><label>Couv. Couleur</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-cover-type" value="recto" id="lcr" checked><label for="lcr">Recto</label></div><div class="radio-option"><input type="radio" name="livre-cover-type" value="rectoVerso" id="lcrv"><label for="lcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Pelliculage</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-pelliculage" value="sans" id="lps" checked><label for="lps">Non</label></div><div class="radio-option"><input type="radio" name="livre-pelliculage" value="avec" id="lpa"><label for="lpa">Oui</label></div></div></div>
            </div>

            <button class="btn" onclick="calculateQuote()">‚ö° Calculer le prix</button>
        </div>

        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h3>üí∞ R√©sultat</h3>
            <div class="price-display"><span id="total-price">0.00</span> DT</div>
            <p>Ref: <strong id="quote-ref">--</strong></p>
            <div class="workflow-actions" id="workflow-panel" style="opacity: 0.5; pointer-events: none;">
                <div class="workflow-step">
                    <div class="step-title">1. Documents PDF</div>
                    <button class="btn-action btn-compta" onclick="openPdfPreview('compta')">üìÑ Bon de Commande (Compta)</button>
                    <button class="btn-action btn-atelier" onclick="openPdfPreview('prod')">üè≠ Fiche Atelier (Prod)</button>
                </div>
                <div class="workflow-step">
                    <div class="step-title">2. Email</div>
                    <button class="btn-action btn-email" onclick="prepareEmail()">üìß Email Validation</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-overlay">
        <div id="pdf-template">
            <div class="pdf-header">
                <div>
                    <h1 class="pdf-title" id="pdf-doc-title">TITRE</h1>
                    <p style="margin: 5px 0;">R√©f: <span id="pdf-ref"></span> | Date: <span id="pdf-date"></span></p>
                </div>
                <div style="text-align:right;">
                    <h2 style="margin:0; color:#2563eb;">SIMPACT</h2>
                    <p style="margin:0; font-size:12px;">Impression Num√©rique & Offset</p>
                </div>
            </div>

            <div class="pdf-info-box">
                <strong>Client :</strong> <span id="pdf-client"></span><br>
                <strong>Commercial :</strong> <span id="pdf-commercial"></span>
            </div>

            <table class="pdf-table">
                <thead>
                    <tr>
                        <th style="width: 60%;">D√©signation</th>
                        <th style="width: 20%; text-align:center;">Quantit√©</th>
                        <th class="pdf-price-header" style="width: 20%; text-align:right;">Prix HT</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <strong id="pdf-prod" style="font-size: 1.2em; display:block; margin-bottom:10px;"></strong>
                            <div id="pdf-desc" style="white-space: pre-line; line-height: 1.5;"></div>
                        </td>
                        <td style="text-align:center; font-size: 1.2em; font-weight: bold;" id="pdf-qty"></td>
                        <td class="pdf-price-col" style="font-size: 1.2em; font-weight: bold;" id="pdf-price"></td>
                    </tr>
                </tbody>
            </table>

            <div id="atelier-notes" style="border: 2px dashed #ea580c; padding: 20px; margin-top: 30px;">
                <h3 style="margin-top:0; color:#ea580c; border-bottom: 1px solid #ea580c; padding-bottom: 5px;">‚ö†Ô∏è INSTRUCTIONS ATELIER</h3>
                <div id="pdf-atelier-content" style="font-size: 14px; line-height: 1.6;"></div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="downloadPdf()" style="background: #2563eb; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; font-weight: bold;">üíæ T√âL√âCHARGER LE PDF</button>
                <button onclick="closeOverlay()" style="background: #ccc; color: black; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; margin-left: 10px;">‚ùå FERMER</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const user = checkAuth('commercial');
        if(user) document.getElementById('user-name-display').textContent = user.name;
        
        let currentQuoteData = null;
        let currentMode = '';

        // --- 2. GESTION DES OPTIONS ---
        document.getElementById('product-type').addEventListener('change', function() {
            document.querySelectorAll('.option-group').forEach(el => el.classList.remove('active'));
            if(this.value) document.getElementById(this.value + '-options').classList.add('active');
        });

        // --- 3. CALCUL DU PRIX ---
        // (Version simplifi√©e pour l'exemple - remettre ton moteur complet si besoin)
        function calculateQuote() {
            const type = document.getElementById('product-type').value;
            const qty = parseInt(document.getElementById('quantity').value);
            if(!type || !qty) return alert("Remplissez les champs !");

            // R√©cup√©ration des donn√©es pour le PDF
            let desc = "";
            let prodName = document.getElementById('product-type').selectedOptions[0].text;
            
            // Logique de description D√âTAILL√âE
            if(type === 'flyer') {
                const mode = document.querySelector('input[name="flyer-type"]:checked').nextSibling.textContent;
                const paper = document.getElementById('flyer-paper').selectedOptions[0].text;
                desc = `Format: Standard\nImpression: ${mode}\nPapier: ${paper}`;
            }
            else if(type === 'brochure') {
                const format = document.getElementById('brochure-format').value.toUpperCase();
                const pages = document.getElementById('brochure-pages').value;
                const fin = document.getElementById('brochure-finition').value;
                const papInt = document.getElementById('brochure-interior-paper').selectedOptions[0].text;
                const papCov = document.getElementById('brochure-cover-paper').selectedOptions[0].text;
                
                // R√©cup√©ration FORC√âE des radios
                const covTypeVal = document.querySelector('input[name="brochure-cover-type"]:checked').value;
                const pellVal = document.querySelector('input[name="brochure-pelliculage"]:checked').value;
                
                const covPrint = (covTypeVal === 'recto') ? "Recto Seul" : "Recto / Verso";
                const pell = (pellVal === 'avec') ? "AVEC Pelliculage" : "SANS Pelliculage";

                desc = `Format: ${format} - ${pages} Pages\nFinition: ${fin}\n----------------\nPapier Int√©rieur: ${papInt}\nPapier Couverture: ${papCov}\n>>> Impression Couv: ${covPrint}\n>>> Finition Couv: ${pell}`;
            }
            // (Ajouter les autres produits ici avec la m√™me logique)
            else {
                desc = "Description standard produit..."; 
            }

            // Simulation Prix
            const price = (qty * 0.5).toFixed(2);
            const ref = "D-" + Math.floor(Math.random() * 1000000);

            // Mise √† jour UI
            document.getElementById('total-price').textContent = price + " DT";
            document.getElementById('quote-ref').textContent = ref;
            document.getElementById('workflow-panel').style.opacity = "1";
            document.getElementById('workflow-panel').style.pointerEvents = "auto";

            // Sauvegarde
            currentQuoteData = {
                client: document.getElementById('client-name').value || "Client",
                prod: prodName,
                qty: qty,
                price: price + " DT",
                ref: ref,
                desc: desc,
                user: user.name
            };
        }

        // --- 4. GESTION PDF (OVERLAY) ---
        function openPdfPreview(mode) {
            if(!currentQuoteData) return;
            currentMode = mode;
            
            const overlay = document.getElementById('pdf-overlay');
            const template = document.getElementById('pdf-template');
            
            // Reset classes
            template.className = (mode === 'compta') ? 'mode-compta' : 'mode-prod';
            
            // Remplissage
            document.getElementById('pdf-ref').textContent = currentQuoteData.ref;
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString();
            document.getElementById('pdf-client').textContent = currentQuoteData.client;
            document.getElementById('pdf-commercial').textContent = currentQuoteData.user;
            document.getElementById('pdf-prod').textContent = currentQuoteData.prod.toUpperCase();
            document.getElementById('pdf-desc').textContent = currentQuoteData.desc;
            document.getElementById('pdf-qty').textContent = currentQuoteData.qty;
            document.getElementById('pdf-price').textContent = currentQuoteData.price;
            
            // Titre et Couleurs
            const titleEl = document.getElementById('pdf-doc-title');
            if(mode === 'compta') {
                titleEl.textContent = "BON DE COMMANDE";
                titleEl.style.color = "#2563eb";
            } else {
                titleEl.textContent = "ORDRE DE FABRICATION";
                titleEl.style.color = "#ea580c";
                document.getElementById('pdf-atelier-content').textContent = currentQuoteData.desc;
            }

            overlay.style.display = 'flex'; // Afficher l'overlay
        }

        function downloadPdf() {
            const element = document.getElementById('pdf-template');
            // Cacher temporairement les boutons pour le PDF
            const buttons = element.querySelectorAll('button');
            buttons.forEach(b => b.style.display = 'none');

            const opt = {
                margin: 10,
                filename: `Simpact_${currentMode}_${currentQuoteData.ref}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).save().then(() => {
                // Remettre les boutons
                buttons.forEach(b => b.style.display = 'inline-block');
                closeOverlay();
            });
        }

        function closeOverlay() {
            document.getElementById('pdf-overlay').style.display = 'none';
        }

        function prepareEmail() {
            if(!currentQuoteData) return;
            const subject = `Commande ${currentQuoteData.ref} - ${currentQuoteData.client}`;
            window.location.href = `mailto:?subject=${subject}&body=Voir fichiers joints.`;
        }
    </script>
</body>
</html>
