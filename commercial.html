<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Commercial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --text: #1e293b; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
        header { grid-column: 1 / -1; background: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: #475569; }
        select, input { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        .option-group { display: none; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .option-group.active { display: block; }
        .radio-group { display: flex; gap: 10px; }
        .radio-option { flex: 1; }
        .radio-option input { display: none; }
        .radio-option label { display: block; padding: 10px; border: 1px solid var(--border); text-align: center; border-radius: 6px; cursor: pointer; background: white; transition: 0.2s; }
        .radio-option input:checked + label { background: var(--primary); color: white; border-color: var(--primary); }
        .price-display { font-size: 3rem; font-weight: 700; color: var(--primary); font-family: 'Space Mono', monospace; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; background: #0f172a; color: white; transition: 0.2s; }
        
        .btn-validate { background: #10b981; color: white; width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-validate:hover { background: #059669; transform: translateY(-2px); }
        
        /* Overlay et autres styles identiques aux pr√©c√©dents pour le PDF */
        #pdf-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; justify-content: center; align-items: flex-start; overflow-y: auto; padding: 20px; }
        #pdf-template { background: white; width: 210mm; min-height: 297mm; padding: 20mm; box-shadow: 0 0 20px rgba(0,0,0,0.5); font-family: Arial, sans-serif; color: #000; box-sizing: border-box; position: relative; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; border: 2px solid #000; }
        .pdf-table th { background: #eee; border: 1px solid #000; padding: 10px; text-align: left; }
        .pdf-table td { border: 1px solid #000; padding: 12px; }
        .mode-prod .pdf-price-col { display: none; } .mode-prod .pdf-price-header { display: none; } .mode-compta #atelier-notes { display: none; } .mode-prod #atelier-notes { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="margin:0;">üí† Simpact Commercial</h2>
            </div>
            <div>
                <span id="user-name-display" style="font-weight:bold; margin-right:10px;">--</span>
                <button onclick="logout()" style="background:#fee2e2; color:#991b1b; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">D√©connexion</button>
            </div>
        </header>

        <div class="card">
            <h3>üõ†Ô∏è Configuration</h3>
            <div class="form-group"><label>Client</label><input type="text" id="client-name" placeholder="Nom du client..."></div>
            <div class="form-group"><label>Produit</label><select id="product-type"><option value="">-- S√©lectionner --</option><option value="flyer">Flyers</option><option value="carte">Cartes de visite</option><option value="depliant">D√©pliants 3 volets</option><option value="entete">Papier √† en-t√™te</option><option value="brochure">Brochure couleur</option><option value="livre">Livre N&B</option><option value="affiches">Affiches Grand Format</option></select></div>
            <div class="form-group"><label>Quantit√©</label><input type="number" id="quantity" placeholder="Ex: 500"></div>

            <div id="flyer-options" class="option-group"><div class="form-group"><label>Impression</label><div class="radio-group"><div class="radio-option"><input type="radio" name="flyer-type" value="recto" id="fr" checked><label for="fr">Recto</label></div><div class="radio-option"><input type="radio" name="flyer-type" value="rectoVerso" id="frv"><label for="frv">R/V</label></div></div></div><div class="form-group"><label>Papier</label><select id="flyer-paper"><option value="couche-135-brillant">135g Brillant</option></select></div></div>
            <div id="carte-options" class="option-group"><div class="form-group"><label>Finition</label><div class="radio-group"><div class="radio-option"><input type="radio" name="carte-finish" value="recto" id="cr" checked><label for="cr">Standard</label></div><div class="radio-option"><input type="radio" name="carte-finish" value="pellicule" id="cp"><label for="cp">Pellicul√©</label></div></div></div><div class="form-group"><label>Papier</label><select id="carte-paper"><option value="couche-350-mat">350g Mat</option></select></div></div>
            <div id="depliant-options" class="option-group"><div class="form-group"><label>Papier</label><select id="depliant-paper"><option value="couche-135-brillant">135g Brillant</option></select></div></div>
            <div id="entete-options" class="option-group"><div class="form-group"><label>Papier</label><select id="entete-paper"><option value="offset-80">80g</option></select></div></div>
            <div id="affiches-options" class="option-group"><div class="form-group"><label>Format</label><select id="affiche-format"><option value="a3">A3</option></select></div><div class="form-group"><label>Papier</label><select id="affiche-paper"><option value="couche-135-brillant">135g Brillant</option></select></div></div>
            
            <div id="brochure-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="brochure-format"><option value="a4">A4</option><option value="a5">A5</option></select></div>
                <div class="form-group"><label>Pages</label><input type="number" id="brochure-pages"></div>
                <div class="form-group"><label>Int√©rieur</label><select id="brochure-interior-paper"><option value="couche-135-brillant">135g Brillant</option></select></div>
                <div class="form-group"><label>Couverture</label><select id="brochure-cover-paper"><option value="couche-250-brillant">250g Brillant</option></select></div>
                <div class="form-group"><label>Type Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-cover-type" value="recto" id="bcr" checked><label for="bcr">Recto</label></div><div class="radio-option"><input type="radio" name="brochure-cover-type" value="rectoVerso" id="bcrv"><label for="bcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Finition</label><select id="brochure-finition"><option value="Piqu√©e √† cheval">Piqu√©e √† cheval</option></select></div>
                <div class="form-group"><label>Pelliculage</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="sans" id="bps" checked><label for="bps">Non</label></div><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="avec" id="bpa"><label for="bpa">Oui</label></div></div></div>
            </div>

            <div id="livre-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="livre-format"><option value="a4">A4</option></select></div>
                <div class="form-group"><label>Pages</label><input type="number" id="livre-pages"></div>
                <div class="form-group"><label>Int√©rieur</label><select id="livre-interior-paper"><option value="offset-80">80g</option></select></div>
                <div class="form-group"><label>Couverture</label><select id="livre-cover-paper"><option value="couche-250-brillant">250g</option></select></div>
                <div class="form-group"><label>Type Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-cover-type" value="recto" id="lcr" checked><label for="lcr">Recto</label></div><div class="radio-option"><input type="radio" name="livre-cover-type" value="rectoVerso" id="lcrv"><label for="lcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Pelliculage</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-pelliculage" value="sans" id="lps" checked><label for="lps">Non</label></div><div class="radio-option"><input type="radio" name="livre-pelliculage" value="avec" id="lpa"><label for="lpa">Oui</label></div></div></div>
            </div>

            <button class="btn" onclick="calculateQuote()">‚ö° Calculer</button>
        </div>

        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h3>üí∞ R√©sultat</h3>
            <div class="price-display"><span id="total-price">0.00</span> DT</div>
            <p>Ref: <strong id="quote-ref">--</strong></p>
            
            <div id="workflow-panel" style="opacity: 0.5; pointer-events: none;">
                <button class="btn-validate" onclick="sendOrderToSystem()">‚úÖ VALIDER LA COMMANDE</button>
                <p style="font-size:0.8rem; color:#64748b; text-align:center; margin-top:5px;">Envoie direct √† la Prod & Compta</p>

                <hr style="border:0; border-top:1px dashed #cbd5e1; margin: 20px 0;">

                <div style="display:flex; gap:10px;">
                    <button style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer;" onclick="openPdfPreview('compta')">üìÑ PDF Compta</button>
                    <button style="flex:1; padding:10px; border-radius:6px; border:1px solid #ddd; background:white; cursor:pointer;" onclick="openPdfPreview('prod')">üè≠ PDF Prod</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-overlay"><div id="pdf-template"></div><div id="pdf-actions"><button onclick="downloadPdf()">T√©l√©charger</button><button onclick="closeOverlay()">Fermer</button></div></div>

    <script>
        const user = checkAuth('commercial');
        if(user) document.getElementById('user-name-display').textContent = user.name;
        
        // --- LOGIQUE DE CALCUL (SIMPLIFI√âE POUR CET EXEMPLE, GARDE TON MOTEUR COMPLET) ---
        // Je remets une version tr√®s basique pour que le fichier fonctionne, 
        // mais tu dois garder ton script "calculateQuote" complet pr√©c√©dent.
        
        let currentQuoteData = null;
        
        function calculateQuote() {
            // (Ins√®re ici ton gros bloc de calculs calculateQuote() du fichier pr√©c√©dent)
            // Pour l'exemple, je simule :
            const qty = document.getElementById('quantity').value || 100;
            const price = (qty * 0.5).toFixed(2);
            const ref = "D-" + Date.now().toString().slice(-6);
            const prod = document.getElementById('product-type').selectedOptions[0].text;
            
            document.getElementById('total-price').textContent = price;
            document.getElementById('quote-ref').textContent = ref;
            document.getElementById('workflow-panel').style.opacity = "1";
            document.getElementById('workflow-panel').style.pointerEvents = "auto";

            currentQuoteData = {
                ref: ref,
                date: new Date().toLocaleDateString(),
                client: document.getElementById('client-name').value || "Client Comptoir",
                prod: prod,
                qty: qty,
                price: price,
                desc: "Description technique...", // Ta variable config compl√®te
                statusProd: "En attente",
                statusCompta: "Non pay√©",
                commercial: user.name
            };
        }

        // --- NOUVELLE FONCTION : ENVOI A LA "BASE DE DONN√âES" ---
        function sendOrderToSystem() {
            if(!currentQuoteData) return;
            
            if(confirm("Valider cette commande et l'envoyer √† l'atelier ?")) {
                saveOrder(currentQuoteData); // Fonction de users.js
                alert("‚úÖ Commande envoy√©e avec succ√®s !\nLa production et la comptabilit√© peuvent maintenant la voir.");
                window.location.reload(); // On recharge pour une nouvelle commande
            }
        }

        // (Garde les fonctions openPdfPreview, downloadPdf, etc.)
    </script>
</body>
</html>
