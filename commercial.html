<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simpact - Espace Commercial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="users.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --text: #1e293b; --bg: #f1f5f9; --border: #cbd5e1; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
        
        /* HEADER */
        header { grid-column: 1 / -1; background: white; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-badge { background: #eff6ff; color: var(--primary); padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
        .logout-btn { background: #fee2e2; color: #991b1b; border: none; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* CARDS */
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; color: #475569; }
        select, input { width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 1rem; box-sizing: border-box; }
        
        /* OPTIONS */
        .option-group { display: none; background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 1.5rem; }
        .option-group.active { display: block; }
        
        /* RADIOS */
        .radio-group { display: flex; gap: 10px; }
        .radio-option { flex: 1; }
        .radio-option input { display: none; }
        .radio-option label { display: block; padding: 10px; border: 1px solid var(--border); text-align: center; border-radius: 6px; cursor: pointer; background: white; font-size: 0.9rem; transition: 0.2s; }
        .radio-option input:checked + label { background: var(--primary); color: white; border-color: var(--primary); }

        /* RESULTATS */
        .price-display { font-size: 3rem; font-weight: 700; color: var(--primary); font-family: 'Space Mono', monospace; }
        .btn { width: 100%; padding: 1rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; margin-top: 1rem; background: #0f172a; color: white; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        
        /* WORKFLOW */
        .workflow-actions { margin-top: 20px; border-top: 2px dashed #e2e8f0; padding-top: 20px; transition: opacity 0.3s; }
        .workflow-step { margin-bottom: 15px; }
        .step-title { font-size: 0.85rem; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 8px; }
        .btn-action { width: 100%; padding: 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; font-size: 0.9rem; }
        .btn-compta { background: #dcfce7; color: #166534; } 
        .btn-atelier { background: #ffedd5; color: #9a3412; }
        .btn-email { background: #2563eb; color: white; }

        /* STYLE PDF (Invisible √† l'√©cran) */
        #pdf-template { 
            display: none; 
            padding: 40px; 
            font-family: sans-serif; 
            color: #000; /* Force noir */
            background: white; 
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex; align-items:center; gap:10px;">
                <h2 style="margin:0;">üí† Simpact Commercial</h2>
            </div>
            <div class="user-info">
                <span class="user-badge" id="user-name-display">--</span>
                <button class="logout-btn" onclick="logout()">D√©connexion</button>
            </div>
        </header>

        <div class="card">
            <h3>üõ†Ô∏è Configuration du Devis</h3>
            <div class="form-group"><label>Client</label><input type="text" id="client-name" placeholder="Nom du client..."></div>
            <div class="form-group">
                <label>Produit</label>
                <select id="product-type">
                    <option value="">-- S√©lectionner --</option>
                    <option value="flyer">Flyers</option>
                    <option value="carte">Cartes de visite</option>
                    <option value="depliant">D√©pliants 3 volets</option>
                    <option value="entete">Papier √† en-t√™te</option>
                    <option value="brochure">Brochure couleur</option>
                    <option value="livre">Livre N&B</option>
                    <option value="affiches">Affiches Grand Format</option>
                </select>
            </div>
            <div class="form-group"><label>Quantit√©</label><input type="number" id="quantity" placeholder="Ex: 500"></div>

            <div id="flyer-options" class="option-group">
                <div class="form-group"><label>Impression</label><div class="radio-group"><div class="radio-option"><input type="radio" name="flyer-type" value="recto" id="fr" checked><label for="fr">Recto</label></div><div class="radio-option"><input type="radio" name="flyer-type" value="rectoVerso" id="frv"><label for="frv">R/V</label></div></div></div>
                <div class="form-group"><label>Papier</label>
                    <select id="flyer-paper">
                        <option value="couche-90-mat">Couch√© 90gr Mat</option>
                        <option value="couche-90-brillant">Couch√© 90gr Brillant</option>
                        <option value="couche-115-mat">Couch√© 115gr Mat</option>
                        <option value="couche-115-brillant">Couch√© 115gr Brillant</option>
                        <option value="couche-135-mat">Couch√© 135gr Mat</option>
                        <option value="couche-135-brillant">Couch√© 135gr Brillant</option>
                        <option value="couche-170-mat">Couch√© 170gr Mat</option>
                        <option value="couche-170-brillant">Couch√© 170gr Brillant</option>
                        <option value="couche-200-mat">Couch√© 200gr Mat</option>
                        <option value="couche-200-brillant">Couch√© 200gr Brillant</option>
                    </select>
                </div>
            </div>

            <div id="carte-options" class="option-group">
                <div class="form-group"><label>Finition</label><div class="radio-group"><div class="radio-option"><input type="radio" name="carte-finish" value="recto" id="cr" checked><label for="cr">Standard</label></div><div class="radio-option"><input type="radio" name="carte-finish" value="pellicule" id="cp"><label for="cp">Pellicul√©</label></div></div></div>
                <div class="form-group"><label>Papier</label>
                    <select id="carte-paper">
                        <option value="couche-300-mat">Couch√© 300gr Mat</option>
                        <option value="couche-300-brillant">Couch√© 300gr Brillant</option>
                        <option value="couche-350-mat">Couch√© 350gr Mat</option>
                        <option value="couche-350-brillant">Couch√© 350gr Brillant</option>
                    </select>
                </div>
            </div>

            <div id="depliant-options" class="option-group">
                <div class="form-group"><label>Papier</label>
                    <select id="depliant-paper">
                        <option value="couche-115-mat">Couch√© 115gr Mat</option>
                        <option value="couche-115-brillant">Couch√© 115gr Brillant</option>
                        <option value="couche-135-mat">Couch√© 135gr Mat</option>
                        <option value="couche-135-brillant">Couch√© 135gr Brillant</option>
                        <option value="couche-170-mat">Couch√© 170gr Mat</option>
                        <option value="couche-170-brillant">Couch√© 170gr Brillant</option>
                    </select>
                </div>
            </div>

            <div id="entete-options" class="option-group">
                <div class="form-group"><label>Papier</label>
                    <select id="entete-paper">
                        <option value="offset-80">Offset 80gr Standard</option>
                        <option value="offset-100">Offset 100gr Premium</option>
                    </select>
                </div>
            </div>

            <div id="brochure-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="brochure-format"><option value="a4">A4 (21x29.7 cm)</option><option value="a5">A5 (14.8x21 cm)</option></select></div>
                <div class="form-group"><label>Pages (Multiple de 4)</label><input type="number" id="brochure-pages" placeholder="Ex: 8, 12, 16..."></div>
                
                <div class="form-group"><label>Papier Int√©rieur</label>
                    <select id="brochure-interior-paper">
                        <option value="couche-90-mat">Couch√© 90gr Mat</option>
                        <option value="couche-90-brillant">Couch√© 90gr Brillant</option>
                        <option value="couche-115-mat">Couch√© 115gr Mat</option>
                        <option value="couche-115-brillant">Couch√© 115gr Brillant</option>
                        <option value="couche-135-mat">Couch√© 135gr Mat</option>
                        <option value="couche-135-brillant">Couch√© 135gr Brillant</option>
                        <option value="couche-170-mat">Couch√© 170gr Mat</option>
                        <option value="couche-170-brillant">Couch√© 170gr Brillant</option>
                        <option value="offset-80">Offset 80gr</option>
                        <option value="offset-100">Offset 100gr</option>
                    </select>
                </div>
                
                <div class="form-group"><label>Papier Couverture</label>
                    <select id="brochure-cover-paper">
                        <option value="couche-250-mat">Couch√© 250gr Mat</option>
                        <option value="couche-250-brillant">Couch√© 250gr Brillant</option>
                        <option value="couche-300-mat">Couch√© 300gr Mat</option>
                        <option value="couche-300-brillant">Couch√© 300gr Brillant</option>
                        <option value="couche-350-mat">Couch√© 350gr Mat</option>
                        <option value="couche-350-brillant">Couch√© 350gr Brillant</option>
                    </select>
                </div>
                
                <div class="form-group"><label>Type Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-cover-type" value="recto" id="bcr" checked><label for="bcr">Recto</label></div><div class="radio-option"><input type="radio" name="brochure-cover-type" value="rectoVerso" id="bcrv"><label for="bcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Finition</label><select id="brochure-finition"><option value="Piqu√©e √† cheval">Piqu√©e √† cheval (Agraf√©)</option><option value="Dos carr√© coll√©">Dos carr√© coll√©</option><option value="Spirale">Spirale</option></select></div>
                <div class="form-group"><label>Pelliculage Couv.</label><div class="radio-group"><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="sans" id="bps" checked><label for="bps">Non</label></div><div class="radio-option"><input type="radio" name="brochure-pelliculage" value="avec" id="bpa"><label for="bpa">Oui</label></div></div></div>
            </div>

            <div id="livre-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="livre-format"><option value="a4">A4</option><option value="a5">A5</option></select></div>
                <div class="form-group"><label>Pages</label><input type="number" id="livre-pages"></div>
                <div class="form-group"><label>Int√©rieur</label><select id="livre-interior-paper"><option value="offset-80">Offset 80gr</option><option value="offset-100">Offset 100gr</option></select></div>
                <div class="form-group"><label>Couverture</label>
                    <select id="livre-cover-paper">
                        <option value="couche-250-mat">Couch√© 250gr Mat</option>
                        <option value="couche-250-brillant">Couch√© 250gr Brillant</option>
                        <option value="couche-300-mat">Couch√© 300gr Mat</option>
                        <option value="couche-300-brillant">Couch√© 300gr Brillant</option>
                        <option value="couche-350-mat">Couch√© 350gr Mat</option>
                        <option value="couche-350-brillant">Couch√© 350gr Brillant</option>
                    </select>
                </div>
                <div class="form-group"><label>Couv. Couleur</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-cover-type" value="recto" id="lcr" checked><label for="lcr">Recto</label></div><div class="radio-option"><input type="radio" name="livre-cover-type" value="rectoVerso" id="lcrv"><label for="lcrv">R/V</label></div></div></div>
                <div class="form-group"><label>Pelliculage</label><div class="radio-group"><div class="radio-option"><input type="radio" name="livre-pelliculage" value="sans" id="lps" checked><label for="lps">Non</label></div><div class="radio-option"><input type="radio" name="livre-pelliculage" value="avec" id="lpa"><label for="lpa">Oui</label></div></div></div>
            </div>

            <div id="affiches-options" class="option-group">
                <div class="form-group"><label>Format</label><select id="affiche-format"><option value="a3">A3 (30x42 cm)</option><option value="a3plus">A3+ (32x48 cm)</option></select></div>
                <div class="form-group"><label>Papier</label>
                    <select id="affiche-paper">
                        <option value="couche-135-mat">Couch√© 135gr Mat</option>
                        <option value="couche-135-brillant">Couch√© 135gr Brillant</option>
                        <option value="couche-170-mat">Couch√© 170gr Mat</option>
                        <option value="couche-170-brillant">Couch√© 170gr Brillant</option>
                        <option value="couche-200-mat">Couch√© 200gr Mat</option>
                        <option value="couche-200-brillant">Couch√© 200gr Brillant</option>
                    </select>
                </div>
            </div>

            <button class="btn" onclick="calculateQuote()">‚ö° Calculer le prix</button>
        </div>

        <div class="card" style="height: fit-content; position: sticky; top: 20px;">
            <h3>üí∞ R√©sultat</h3>
            <div class="price-display"><span id="total-price">0.00</span> DT</div>
            <p style="color:#64748b; font-size:0.9rem;">Ref: <span id="quote-ref" style="font-family:monospace; font-weight:bold;">--</span></p>

            <div class="workflow-actions" id="workflow-panel" style="opacity: 0.5; pointer-events: none;">
                <div class="workflow-step">
                    <div class="step-title">1. Documents Internes</div>
                    <button class="btn-action btn-compta" onclick="generatePDF('compta')">üìÑ T√©l√©charger Bon de Commande (Compta)</button>
                    <button class="btn-action btn-atelier" onclick="generatePDF('prod')">üè≠ T√©l√©charger Fiche Atelier (Prod)</button>
                </div>
                
                <div class="workflow-step">
                    <div class="step-title">2. Finalisation</div>
                    <button class="btn-action btn-email" onclick="prepareEmail()">üìß Pr√©parer l'email de validation</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <div style="display:flex; justify-content:space-between; border-bottom:3px solid #000; padding-bottom:20px; margin-bottom:30px;">
            <div>
                <h1 id="pdf-doc-title" style="margin:0; font-size:24px; text-transform:uppercase;">TITRE DOCUMENT</h1>
                <p style="margin:5px 0; color: #000;">R√©f: <span id="pdf-ref"></span> | Date: <span id="pdf-date"></span></p>
            </div>
            <div style="text-align:right;">
                <h2 style="margin:0; color:#2563eb;">SIMPACT</h2>
                <p style="margin:0; font-size:12px; color: #000;">Impression Num√©rique & Offset</p>
            </div>
        </div>

        <div style="background:#f3f4f6; padding:15px; border-radius:5px; margin-bottom:20px; border: 1px solid #ddd;">
            <strong style="color: #000;">Client :</strong> <span id="pdf-client" style="color: #000;"></span><br>
            <strong style="color: #000;">Commercial :</strong> <span id="pdf-commercial" style="color: #000;"></span>
        </div>

        <table style="width:100%; border-collapse:collapse; margin-bottom:30px; border: 1px solid #000;">
            <tr style="background:#e5e7eb;">
                <th style="padding:10px; text-align:left; border:1px solid #000; color: #000;">D√©signation</th>
                <th style="padding:10px; text-align:center; border:1px solid #000; color: #000;">Quantit√©</th>
                <th class="price-col" style="padding:10px; text-align:right; border:1px solid #000; color: #000;">Prix HT</th>
            </tr>
            <tr>
                <td style="padding:15px; border:1px solid #000; vertical-align: top;">
                    <strong id="pdf-prod" style="font-size: 1.1em; color: #000;"></strong><br><br>
                    <span id="pdf-desc" style="font-size:14px; color:#000; line-height: 1.5;"></span>
                </td>
                <td style="padding:15px; text-align:center; border:1px solid #000; font-weight:bold; font-size:1.2em; color: #000;" id="pdf-qty"></td>
                <td class="price-col" style="padding:15px; text-align:right; border:1px solid #000; font-weight:bold; color: #000;" id="pdf-price"></td>
            </tr>
        </table>

        <div id="atelier-notes" style="display:none; border:2px dashed #f97316; padding:15px; margin-top:30px;">
            <h3 style="margin-top:0; color:#c2410c;">‚ö†Ô∏è INSTRUCTIONS ATELIER</h3>
            <div id="pdf-atelier-content" style="font-size: 14px; line-height: 1.6; color: #000;">
                </div>
        </div>
    </div>

    <script>
        // 1. AUTHENTIFICATION
        const user = checkAuth('commercial');
        if(user) document.getElementById('user-name-display').textContent = user.name;

        // 2. DONNEES ET CALCULS
        let TARIFS = {};
        const PRIX_FIXES = { pelliculage: 0.1, feuille_nb: 0.2, offset_100: 0.014, gramme_couche: 0.0007, min_price: 28 };
        let currentQuoteData = null; // Stocke les infos pour le PDF

        async function loadPrices() {
            try {
                const r = await fetch('prix_config.json');
                const data = await r.json();
                TARIFS = {
                    flyer: { recto: data.tarifs.flyer.recto, rectoVerso: data.tarifs.flyer.rectoVerso },
                    carte: { recto: data.tarifs.carte.recto, pellicule: data.tarifs.carte.pellicule },
                    depliant: data.tarifs.depliant, entete: data.tarifs.entete,
                    prix_couverture_livre: data.prix_couverture_livre || { a4: { recto: 1.3, rectoVerso: 1.5 }, a5: { recto: 0.65, rectoVerso: 0.75 } }
                };
            } catch(e) { console.log("Erreur chargement prix"); }
        }
        loadPrices();

        // Gestion affichage options
        document.getElementById('product-type').addEventListener('change', function() {
            document.querySelectorAll('.option-group').forEach(el => el.classList.remove('active'));
            if(this.value) document.getElementById(this.value + '-options').classList.add('active');
        });

        // Helpers
        function getPaperName(paperType) {
            if(!paperType) return '';
            if(paperType === 'offset-80') return 'Offset 80gr Standard';
            if(paperType === 'offset-100') return 'Offset 100gr Premium';
            if(paperType.startsWith('couche-')) {
                const parts = paperType.split('-');
                return `Couch√© ${parts[1]}gr ${parts[2] === 'mat' ? 'Mat' : 'Brillant'}`;
            }
            return paperType;
        }

        function calculatePaperSurcharge(paperType, numSheets) {
            if(!paperType || numSheets === 0) return 0;
            if(paperType === 'offset-100') return numSheets * PRIX_FIXES.offset_100;
            if(paperType.startsWith('couche-')) {
                const parts = paperType.split('-');
                if (parts.length >= 2) {
                    const grammage = parseInt(parts[1]);
                    const grammesSup = grammage - 90;
                    if (grammesSup > 0) return numSheets * grammesSup * PRIX_FIXES.gramme_couche;
                }
            }
            return 0;
        }

        function getPricePerSheetCouleur(sheets) {
            if(sheets < 25) return 3; if(sheets < 50) return 2.5; if(sheets < 100) return 2;
            if(sheets < 200) return 1.9; if(sheets < 300) return 1.8; if(sheets < 400) return 1.7;
            if(sheets < 500) return 1.6; return 1.5;
        }
        
        function getPricePerSheetRecto(sheets) { return getPricePerSheetCouleur(sheets) - 0.2; }

        function calculatePriceWithSmoothing(tarifArray, quantity) {
            if(!tarifArray) return { totalPrice: 0 };
            let lower = tarifArray[0], upper = tarifArray[0];
            for(let t of tarifArray) { if(t.qty <= quantity) lower = t; if(t.qty >= quantity && upper === tarifArray[0]) upper = t; }
            if(lower.qty === upper.qty) return { totalPrice: lower.price };
            const ratio = (quantity - lower.qty) / (upper.qty - lower.qty);
            return { totalPrice: lower.price + (upper.price - lower.price) * ratio };
        }

        // --- CALCUL CENTRAL ---
        function calculateQuote() {
            const type = document.getElementById('product-type').value;
            const qty = parseInt(document.getElementById('quantity').value);
            if(!type || !qty) return alert("Veuillez remplir le produit et la quantit√©");

            let totalPrice = 0, config = "";

            try {
                if(type === 'flyer') {
                    const mode = document.querySelector('input[name="flyer-type"]:checked').value;
                    const paper = document.getElementById('flyer-paper').value;
                    let res = calculatePriceWithSmoothing(TARIFS.flyer[mode], qty);
                    totalPrice = res.totalPrice + calculatePaperSurcharge(paper, qty);
                    config = `Flyer Format Standard\nImpression: ${mode === 'recto' ? 'Recto' : 'Recto/Verso'}\nPapier: ${getPaperName(paper)}`;
                }
                else if(type === 'carte') {
                    const finish = document.querySelector('input[name="carte-finish"]:checked').value;
                    const paper = document.getElementById('carte-paper').value;
                    let res = calculatePriceWithSmoothing(TARIFS.carte[finish], qty);
                    totalPrice = res.totalPrice + calculatePaperSurcharge(paper, Math.ceil(qty/10));
                    config = `Carte de Visite\nFinition: ${finish === 'recto' ? 'Standard' : 'Pellicul√©e'}\nPapier: ${getPaperName(paper)}`;
                }
                else if(type === 'depliant') {
                    const paper = document.getElementById('depliant-paper').value;
                    let res = calculatePriceWithSmoothing(TARIFS.depliant, qty);
                    totalPrice = res.totalPrice + calculatePaperSurcharge(paper, qty);
                    config = `D√©pliant 3 volets (A4 ouvert)\nPapier: ${getPaperName(paper)}`;
                }
                else if(type === 'entete') {
                    const paper = document.getElementById('entete-paper').value;
                    let res = calculatePriceWithSmoothing(TARIFS.entete, qty);
                    totalPrice = res.totalPrice + calculatePaperSurcharge(paper, qty);
                    config = `Papier En-t√™te (A4)\nPapier: ${getPaperName(paper)}`;
                }
                else if(type === 'brochure') {
                    const pages = parseInt(document.getElementById('brochure-pages').value);
                    const format = document.getElementById('brochure-format').value;
                    const coverType = document.querySelector('input[name="brochure-cover-type"]:checked').value;
                    const pell = document.querySelector('input[name="brochure-pelliculage"]:checked').value;
                    const paperInt = document.getElementById('brochure-interior-paper').value;
                    const paperCov = document.getElementById('brochure-cover-paper').value;
                    const finition = document.getElementById('brochure-finition').value;

                    let sheetsInt = Math.ceil((pages / (format === 'a4' ? 4 : 8)) * qty);
                    let sheetsCov = Math.ceil((format === 'a4' ? 1 : 0.5) * qty);
                    let totalSheets = sheetsInt + sheetsCov;
                    let priceSheetInt = getPricePerSheetCouleur(totalSheets);
                    let priceSheetCov = (coverType === 'recto') ? getPricePerSheetRecto(totalSheets) : getPricePerSheetCouleur(totalSheets);
                    
                    let costInt = sheetsInt * priceSheetInt;
                    let costCov = sheetsCov * priceSheetCov;
                    let surcharge = calculatePaperSurcharge(paperInt, sheetsInt) + calculatePaperSurcharge(paperCov, sheetsCov);
                    let costPell = pell === 'avec' ? qty * PRIX_FIXES.pelliculage : 0;

                    totalPrice = costInt + costCov + surcharge + costPell;
                    
                    // DESCRIPTION D√âTAILL√âE POUR ATELIER
                    const coverPrintText = coverType === 'recto' ? 'Couv Recto' : 'Couv Recto/Verso';
                    const pellText = pell === 'avec' ? 'AVEC Pelliculage' : 'SANS Pelliculage';
                    
                    config = `Brochure ${format.toUpperCase()} - ${pages} pages\n` + 
                             `Finition: ${finition}\n` +
                             `Int√©rieur: ${getPaperName(paperInt)}\n` + 
                             `Couverture: ${getPaperName(paperCov)}\n` +
                             `Impression Couv: ${coverPrintText}\n` +
                             `Finition Couv: ${pellText}`;
                }
                else if(type === 'livre') {
                    const pages = parseInt(document.getElementById('livre-pages').value);
                    const format = document.getElementById('livre-format').value;
                    const coverType = document.querySelector('input[name="livre-cover-type"]:checked').value;
                    const pell = document.querySelector('input[name="livre-pelliculage"]:checked').value;
                    const paperInt = document.getElementById('livre-interior-paper').value;
                    const paperCov = document.getElementById('livre-cover-paper').value;

                    let sheetsInt = Math.ceil((pages / (format === 'a4' ? 4 : 8)) * qty);
                    let costInt = sheetsInt * PRIX_FIXES.feuille_nb;
                    let surcharge = calculatePaperSurcharge(paperInt, sheetsInt);
                    let unitCovPrice = coverType === 'recto' ? TARIFS.prix_couverture_livre[format].recto : TARIFS.prix_couverture_livre[format].rectoVerso;
                    let costCov = qty * unitCovPrice;
                    let costPell = pell === 'avec' ? qty * PRIX_FIXES.pelliculage : 0;

                    totalPrice = costInt + surcharge + costCov + costPell;
                    
                    const coverPrintText = coverType === 'recto' ? 'Couv Recto' : 'Couv Recto/Verso';
                    const pellText = pell === 'avec' ? 'AVEC Pelliculage' : 'SANS Pelliculage';
                    
                    config = `Livre N&B ${format.toUpperCase()} - ${pages} pages\n` +
                             `Reliure: Spirale\n` +
                             `Int√©rieur: ${getPaperName(paperInt)}\n` +
                             `Couverture: ${getPaperName(paperCov)}\n` +
                             `Impression Couv: ${coverPrintText}\n` +
                             `Finition Couv: ${pellText}`;
                }
                else if(type === 'affiches') {
                    const format = document.getElementById('affiche-format').value;
                    const paper = document.getElementById('affiche-paper').value;
                    let res = calculatePriceWithSmoothing(TARIFS.flyer.recto, qty);
                    let price = res.totalPrice;
                    if(format === 'a3plus') price *= 1.2;
                    totalPrice = price + calculatePaperSurcharge(paper, qty);
                    config = `Affiche Grand Format ${format === 'a3' ? 'A3' : 'A3+'}\nPapier: ${getPaperName(paper)}`;
                }

                totalPrice = Math.max(totalPrice, PRIX_FIXES.min_price);
                const ref = "D-" + Date.now().toString().slice(-6);

                // Affichage √âcran
                document.getElementById('total-price').textContent = totalPrice.toFixed(2);
                document.getElementById('quote-ref').textContent = ref;
                document.getElementById('workflow-panel').style.opacity = "1";
                document.getElementById('workflow-panel').style.pointerEvents = "auto";

                // Stockage Donn√©es pour PDF
                currentQuoteData = {
                    client: document.getElementById('client-name').value || "Client Comptoir",
                    prod: document.getElementById('product-type').selectedOptions[0].text,
                    qty: qty, 
                    config: config, 
                    price: totalPrice.toFixed(2) + " DT",
                    ref: ref,
                    user: user.name
                };

            } catch(e) { console.error(e); alert("Erreur de calcul."); }
        }

        // 3. GENERATION PDF OPTIMISEE
        function generatePDF(mode) {
            if(!currentQuoteData) return;
            const el = document.getElementById('pdf-template');
            el.style.display = 'block';

            // Remplissage Donn√©es
            document.getElementById('pdf-ref').textContent = currentQuoteData.ref;
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('fr-FR');
            document.getElementById('pdf-client').textContent = currentQuoteData.client;
            document.getElementById('pdf-commercial').textContent = currentQuoteData.user;
            document.getElementById('pdf-prod').textContent = currentQuoteData.prod.toUpperCase();
            
            // Formatage de la description (remplace \n par <br>)
            const descHtml = currentQuoteData.config.replace(/\n/g, '<br>');
            document.getElementById('pdf-desc').innerHTML = descHtml;
            document.getElementById('pdf-qty').textContent = currentQuoteData.qty;

            if (mode === 'compta') {
                // BON DE COMMANDE
                document.getElementById('pdf-doc-title').textContent = "BON DE COMMANDE";
                document.getElementById('pdf-doc-title').style.color = "#2563eb";
                
                // Montrer les prix
                document.querySelectorAll('.price-col').forEach(e => e.style.display = 'table-cell');
                document.getElementById('pdf-price').textContent = currentQuoteData.price;
                
                // Cacher zone atelier
                document.getElementById('atelier-notes').style.display = 'none';
            } else {
                // FICHE ATELIER
                document.getElementById('pdf-doc-title').textContent = "ORDRE DE FABRICATION";
                document.getElementById('pdf-doc-title').style.color = "#ea580c"; // Orange
                
                // Cacher les prix
                document.querySelectorAll('.price-col').forEach(e => e.style.display = 'none');
                
                // Montrer zone atelier avec gros d√©tails
                document.getElementById('atelier-notes').style.display = 'block';
                document.getElementById('pdf-atelier-content').innerHTML = 
                    `<strong>Produit:</strong> ${currentQuoteData.prod}<br>` +
                    `<strong>Quantit√©:</strong> ${currentQuoteData.qty}<br><br>` +
                    `<strong>D√âTAILS TECHNIQUES:</strong><br>` +
                    descHtml;
            }

            // G√©n√©ration
            const opt = { 
                margin: 10, 
                filename: `Simpact_${mode}_${currentQuoteData.ref}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };

            html2pdf().from(el).set(opt).save().then(() => { 
                el.style.display = 'none'; // Cacher apr√®s g√©n√©ration
            });
        }

        // 4. EMAIL
        function prepareEmail() {
            if(!currentQuoteData) return;
            const subject = encodeURIComponent(`Commande Simpact ${currentQuoteData.ref} - ${currentQuoteData.client}`);
            const body = encodeURIComponent(`Bonjour,\n\nCommande R√©f: ${currentQuoteData.ref}\nClient : ${currentQuoteData.client}\nProduit : ${currentQuoteData.prod}\n\nFichiers PDF √† joindre manuellement.\n\nCordialement,\n${user.name}`);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }
    </script>
</body>
</html>
